---
description:
globs:
alwaysApply: false
---
# Cart ë„ë©”ì¸ ì‘ì—… ë‹¨ê³„ë³„ ê°€ì´ë“œ

## í˜„ì¬ ìƒíƒœ ë¶„ì„ (2024ë…„ 12ì›” ì—…ë°ì´íŠ¸)

### âœ… ì™„ë£Œëœ ë¶€ë¶„
- **Domain Layer**: CartItem, ShoppingSession, VOë“¤ ì™„ì „ êµ¬í˜„ âœ…
- **Infrastructure Layer**: Jpo, Repository ì™„ì „ êµ¬í˜„ âœ…
- **Application Layer**: Command, UseCase, Service ì™„ì „ êµ¬í˜„ âœ…
- **GraphQL Adapter Layer**: CartFetcher, CartOutputMapper ì™„ì „ êµ¬í˜„ âœ…
- **ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬**: getUserIdFromContext() ì‚¬ìš©ìœ¼ë¡œ ì™„ë£Œ âœ…
- **Domain-Jpo ë§¤í•‘**: ë„ë©”ì¸ ëª¨ë¸ì—ì„œ ì²˜ë¦¬ (fromJpo, toJpo) âœ…

### âŒ ë¯¸ì™„ì„± ë¶€ë¶„
- **DataLoader ë° FieldFetcher**: N+1 ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ êµ¬í˜„ í•„ìš”
- **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: ì „í˜€ ì—†ìŒ

---

## ğŸ¯ ì‘ì—… ë‹¨ê³„ë³„ ê°€ì´ë“œ (ì—…ë°ì´íŠ¸ë¨)

### Phase 1: N+1 ë¬¸ì œ í•´ê²° (Day 1)

#### Step 1-1: CartItemsDataLoader êµ¬í˜„ (2ì‹œê°„)

**íŒŒì¼**: `src/main/kotlin/kr/co/marketbill/marketbillcoreserver/cart/adapter/in/graphql/dataloader/CartItemsDataLoader.kt`

**êµ¬í˜„í•´ì•¼ í•  ë‚´ìš©**:
```kotlin
@DgsDataLoader(name = "cartItems")
class CartItemsDataLoader(private val cartService: CartService) : 
    MappedBatchLoaderWithContext<Long, CartItemsOutput> {

    override fun load(
        keys: Set<Long>,
        environment: BatchLoaderEnvironment
    ): CompletionStage<Map<Long, CartItemsOutput>> {
        val command = FindShoppingSessionCommand.from(keys)
        val results = cartService.findShoppingSessionsByRetailerIds(command)
        return CompletableFuture.completedFuture(results.mapKeys { it.key.value })
    }
}
```

#### Step 1-2: CartFieldFetcher êµ¬í˜„ (2ì‹œê°„)

**íŒŒì¼**: `src/main/kotlin/kr/co/marketbill/marketbillcoreserver/cart/adapter/in/graphql/datafetcher/CartFieldFetcher.kt`

**êµ¬í˜„í•´ì•¼ í•  ë‚´ìš©**:
```kotlin
@DgsComponent
class CartFieldFetcher {
    
    @DgsData(parentType = "ShoppingSession", field = "cartItems")
    fun cartItems(
        dfe: DgsDataFetchingEnvironment,
        @InputArgument pagination: PaginationInput?
    ): CompletableFuture<CartItemsOutput> {
        val shoppingSession = dfe.getSource<ShoppingSession>()
        val dataLoader = dfe.getDataLoader<Long, CartItemsOutput>(CartItemsDataLoader::class.java)
        
        return dataLoader.load(shoppingSession.id.toLong())
    }
}
```

#### Step 1-3: CartOutputMapper ìˆ˜ì • (1ì‹œê°„)

**íŒŒì¼**: `src/main/kotlin/kr/co/marketbill/marketbillcoreserver/cart/adapter/in/graphql/mapper/CartOutputMapper.kt`

**ìˆ˜ì •í•´ì•¼ í•  ë‚´ìš©**:
```kotlin
fun toShoppingSessionOutput(shoppingSession: DomainShoppingSession): ShoppingSession {
    return ShoppingSession(
        id = shoppingSession.id?.value?.toInt() ?: 0,
        retailer = userOutputMapper.toUser(UserResult.from(shoppingSession.retailer!!)),
        wholesaler = shoppingSession.wholesaler?.let { userOutputMapper.toUser(UserResult.from(it)) },
        memo = shoppingSession.memo?.value,
        // cartItems í•„ë“œ ì œê±° - DataLoaderë¡œ ì²˜ë¦¬
        createdAt = shoppingSession.createdAt?.toLocalDate() ?: LocalDate.now(),
        updatedAt = shoppingSession.updatedAt?.toLocalDate() ?: LocalDate.now(),
        deletedAt = shoppingSession.deletedAt?.toLocalDate()
    )
}
```

#### Step 1-4: Serviceì— ë°°ì¹˜ ì¡°íšŒ ë©”ì„œë“œ ì¶”ê°€ (1ì‹œê°„)

**íŒŒì¼**: `src/main/kotlin/kr/co/marketbill/marketbillcoreserver/cart/application/service/CartService.kt`

**ì¶”ê°€í•´ì•¼ í•  ë‚´ìš©**:
```kotlin
fun findShoppingSessionsByRetailerIds(command: FindShoppingSessionCommand): Map<ShoppingSessionId, ShoppingSession> {
    return findShoppingSessionUseCase.executeBatch(command)
}
```

**íŒŒì¼**: `src/main/kotlin/kr/co/marketbill/marketbillcoreserver/cart/application/usecase/FindShoppingSessionUseCase.kt`

**ì¶”ê°€í•´ì•¼ í•  ë‚´ìš©**:
```kotlin
fun executeBatch(command: FindShoppingSessionCommand): Map<ShoppingSessionId, ShoppingSession> {
    return cartRepository.findShoppingSessionsByRetailerIds(command.retailerIds)
}
```

---

### Phase 2: í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± (Day 2)

#### Step 2-1: UseCase ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (4ì‹œê°„)

**íŒŒì¼**: `src/test/kotlin/kr/co/marketbill/marketbillcoreserver/cart/application/usecase/`

**ì‘ì„±í•  í…ŒìŠ¤íŠ¸**:
1. `AddToCartUseCaseTest.kt`
2. `UpdateCartItemUseCaseTest.kt`
3. `RemoveCartItemUseCaseTest.kt`
4. `FindShoppingSessionUseCaseTest.kt`
5. `UpdateShoppingSessionUseCaseTest.kt`

#### Step 2-2: DataLoader í…ŒìŠ¤íŠ¸ (2ì‹œê°„)

**íŒŒì¼**: `src/test/kotlin/kr/co/marketbill/marketbillcoreserver/cart/adapter/in/graphql/dataloader/CartItemsDataLoaderTest.kt`

#### Step 2-3: FieldFetcher í…ŒìŠ¤íŠ¸ (2ì‹œê°„)

**íŒŒì¼**: `src/test/kotlin/kr/co/marketbill/marketbillcoreserver/cart/adapter/in/graphql/datafetcher/CartFieldFetcherTest.kt`

---

### Phase 3: ê²€ì¦ ë° ìµœì¢… ì ê²€ (Day 3)

#### Step 3-1: N+1 ë¬¸ì œ í•´ê²° ê²€ì¦ (2ì‹œê°„)
- GraphQL Playgroundì—ì„œ ì¿¼ë¦¬ ì‹¤í–‰
- DataLoader ë™ì‘ í™•ì¸
- ì„±ëŠ¥ ê°œì„  í™•ì¸

#### Step 3-2: ì»´íŒŒì¼ ë° ë¹Œë“œ ê²€ì¦ (1ì‹œê°„)
- ëª¨ë“  import ì •ìƒ ì‘ë™ í™•ì¸
- íƒ€ì… ë§¤ì¹­ í™•ì¸
- ë¹Œë“œ ì„±ê³µ í™•ì¸

#### Step 3-3: í†µí•© í…ŒìŠ¤íŠ¸ (2ì‹œê°„)
- ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- ì‹¤ì œ DB ì—°ë™ í…ŒìŠ¤íŠ¸
- DataLoader ë™ì‘ í…ŒìŠ¤íŠ¸

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì—…ë°ì´íŠ¸ë¨)

### Phase 1 ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] CartItemsDataLoader êµ¬í˜„
- [ ] CartFieldFetcher êµ¬í˜„
- [ ] CartOutputMapperì—ì„œ cartItems í•„ë“œ ì œê±°
- [ ] Serviceì— ë°°ì¹˜ ì¡°íšŒ ë©”ì„œë“œ ì¶”ê°€
- [ ] UseCaseì— ë°°ì¹˜ ì¡°íšŒ ë©”ì„œë“œ ì¶”ê°€
- [ ] Repositoryì— ë°°ì¹˜ ì¡°íšŒ ë©”ì„œë“œ ì¶”ê°€
- [ ] N+1 ë¬¸ì œ í•´ê²° í™•ì¸

### Phase 2 ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] AddToCartUseCaseTest ì‘ì„±
- [ ] UpdateCartItemUseCaseTest ì‘ì„±
- [ ] RemoveCartItemUseCaseTest ì‘ì„±
- [ ] FindShoppingSessionUseCaseTest ì‘ì„±
- [ ] UpdateShoppingSessionUseCaseTest ì‘ì„±
- [ ] CartItemsDataLoaderTest ì‘ì„±
- [ ] CartFieldFetcherTest ì‘ì„±

### Phase 3 ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] N+1 ë¬¸ì œ í•´ê²° ê²€ì¦
- [ ] ì»´íŒŒì¼ ì„±ê³µ í™•ì¸
- [ ] GraphQL ì¿¼ë¦¬/ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸
- [ ] DataLoader ë™ì‘ í…ŒìŠ¤íŠ¸
- [ ] í†µí•© í…ŒìŠ¤íŠ¸ ì„±ê³µ

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ (ì—…ë°ì´íŠ¸ë¨)

1. **GraphQL ìŠ¤í‚¤ë§ˆëŠ” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ ê²ƒ**
2. **DataLoaderëŠ” N+1 ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ í•„ìˆ˜ êµ¬í˜„**
3. **FieldFetcherëŠ” @DgsData ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ êµ¬í˜„**
4. **Domain-Jpo ë§¤í•‘ì€ ë„ë©”ì¸ ëª¨ë¸ì—ì„œ ì²˜ë¦¬ (fromJpo, toJpo)**
5. **Mapper í´ë˜ìŠ¤ëŠ” ë§Œë“¤ì§€ ë§ ê²ƒ**
6. **í…ŒìŠ¤íŠ¸ëŠ” ë°˜ë“œì‹œ ì‘ì„±í•  ê²ƒ**
7. **MDC ê·œì¹™ì„ ì¤€ìˆ˜í•  ê²ƒ**

---

## ï¿½ï¿½ ì‹œì‘í•˜ê¸° (ì—…ë°ì´íŠ¸ë¨)

**ì¦‰ì‹œ ì‹œì‘í•˜ì„¸ìš”:**

1. **Step 1-1**ë¶€í„° ì‹œì‘: CartItemsDataLoader êµ¬í˜„
2. **ìˆœì„œëŒ€ë¡œ ì§„í–‰**: DataLoader â†’ FieldFetcher â†’ Service/UseCase ë°°ì¹˜ ë©”ì„œë“œ â†’ í…ŒìŠ¤íŠ¸
3. **ì²´í¬ë¦¬ìŠ¤íŠ¸ í™œìš©**: ê° ë‹¨ê³„ ì™„ë£Œ ì‹œ ì²´í¬
4. **N+1 ë¬¸ì œ í•´ê²°**: ì„±ëŠ¥ ìµœì í™”ê°€ í•µì‹¬ ëª©í‘œ

---

## ï¿½ï¿½ ì˜ˆìƒ ì†Œìš” ì‹œê°„ (ì—…ë°ì´íŠ¸ë¨)

| Phase | ì‘ì—… | ì‹œê°„ |
|---|---|---|
| **Phase 1** | DataLoader + FieldFetcher + ë°°ì¹˜ ì¡°íšŒ ë©”ì„œë“œ | 6ì‹œê°„ |
| **Phase 2** | í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± | 8ì‹œê°„ |
| **Phase 3** | ê²€ì¦ ë° ìµœì¢… ì ê²€ | 5ì‹œê°„ |
| **ì´ê³„** | | **19ì‹œê°„ (2-3ì¼)** |

**í•µì‹¬ ëª©í‘œ: N+1 ë¬¸ì œ í•´ê²°ì„ í†µí•œ ì„±ëŠ¥ ìµœì í™”!**

---

## ï¿½ï¿½ í•µì‹¬ ë³€ê²½ì‚¬í•­

### **ì œê±°ëœ ì‘ì—…**
- âŒ **Mapper êµ¬í˜„**: Domain-Jpo ë§¤í•‘ì€ ë„ë©”ì¸ ëª¨ë¸ì—ì„œ ì²˜ë¦¬
- âŒ **CartItemMapper.toDomain()**: ë¶ˆí•„ìš”
- âŒ **ShoppingSessionMapper.toDomain()**: ë¶ˆí•„ìš”

### **ì¶”ê°€ëœ ì‘ì—…**
- âœ… **ë°°ì¹˜ ì¡°íšŒ ë©”ì„œë“œ**: Service, UseCase, Repositoryì— ë°°ì¹˜ ì¡°íšŒ ê¸°ëŠ¥ ì¶”ê°€
- âœ… **DataLoader ìµœì í™”**: N+1 ë¬¸ì œ í•´ê²°ì— ì§‘ì¤‘

**ë„ë©”ì¸ ì¤‘ì‹¬ ì„¤ê³„ë¡œ ë” ê¹”ë”í•œ êµ¬ì¡°ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!**